<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM2 Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: #0f172a; }
        .glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }
        .status-restarting { color: #f59e0b; }
    </style>
</head>
<body class="min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
                <i class="ph-fill ph-circles-three-plus text-4xl text-blue-500"></i>
                <div>
                    <h1 class="text-3xl font-bold text-white">PM2 Dashboard</h1>
                    <p class="text-slate-400">Process Monitor</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-slate-400 text-sm">Last Update</p>
                    <p id="lastUpdate" class="text-white font-semibold">--:--:--</p>
                </div>
                <button onclick="refreshData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                    <i class="ph-bold ph-arrows-clockwise"></i>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Total Processes</p>
                        <p id="totalProcesses" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <i class="ph-fill ph-hard-drives text-3xl text-blue-500"></i>
                </div>
            </div>
            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Online</p>
                        <p id="onlineProcesses" class="text-3xl font-bold text-green-500">0</p>
                    </div>
                    <i class="ph-fill ph-check-circle text-3xl text-green-500"></i>
                </div>
            </div>
            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">CPU Usage</p>
                        <p id="cpuUsage" class="text-3xl font-bold text-white">0%</p>
                    </div>
                    <i class="ph-fill ph-cpu text-3xl text-yellow-500"></i>
                </div>
            </div>
            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Memory Usage</p>
                        <p id="memUsage" class="text-3xl font-bold text-white">0 MB</p>
                    </div>
                    <i class="ph-fill ph-memory text-3xl text-purple-500"></i>
                </div>
            </div>
        </div>

        <!-- Processes Table -->
        <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-6 border-b border-slate-700">
                <h2 class="text-xl font-bold text-white">Processes</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-900">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">CPU</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Memory</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Uptime</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Restarts</th>
                        </tr>
                    </thead>
                    <tbody id="processesTable" class="divide-y divide-slate-700">
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center text-slate-400">
                                <i class="ph-bold ph-spinner animate-spin text-2xl mb-2"></i>
                                <p>Loading processes...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="mt-8 bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-6 border-b border-slate-700 flex items-center justify-between">
                <h2 class="text-xl font-bold text-white">Recent Logs</h2>
                <button onclick="clearLogs()" class="text-slate-400 hover:text-white text-sm transition">Clear</button>
            </div>
            <div id="logsContainer" class="p-6 h-64 overflow-y-auto font-mono text-sm bg-slate-900">
                <p class="text-slate-400">Loading logs...</p>
            </div>
        </div>
    </div>

    <script>
        // Auto-refresh every 5 seconds
        setInterval(refreshData, 5000);

        async function refreshData() {
            try {
                // Fetch processes
                const processesRes = await fetch('/api/processes');
                const processes = await processesRes.json();

                // Update stats
                const total = processes.length;
                const online = processes.filter(p => p.pm2_env.status === 'online').length;
                const totalCpu = processes.reduce((sum, p) => sum + (p.monit?.cpu || 0), 0);
                const totalMem = processes.reduce((sum, p) => sum + (p.monit?.memory || 0), 0);

                document.getElementById('totalProcesses').textContent = total;
                document.getElementById('onlineProcesses').textContent = online;
                document.getElementById('cpuUsage').textContent = totalCpu.toFixed(1) + '%';
                document.getElementById('memUsage').textContent = formatBytes(totalMem);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

                // Update table
                updateProcessesTable(processes);

                // Fetch logs
                const logsRes = await fetch('/api/logs?lines=50');
                const logs = await logsRes.json();
                updateLogs(logs);

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function updateProcessesTable(processes) {
            const tbody = document.getElementById('processesTable');

            if (processes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-slate-400">
                            <i class="ph-bold ph-warning-circle text-2xl mb-2"></i>
                            <p>No processes found. Start a process with PM2 to see it here.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = processes.map(p => {
                const status = p.pm2_env.status;
                const statusClass = status === 'online' ? 'status-online' : status === 'stopped' ? 'status-offline' : 'status-restarting';
                const uptime = p.monit?.uptime ? formatUptime(p.monit.uptime) : '-';

                return `
                    <tr class="hover:bg-slate-700/50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${p.pm2_env.pm_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${p.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="${statusClass} font-semibold capitalize">${status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${(p.monit?.cpu || 0).toFixed(1)}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${formatBytes(p.monit?.memory || 0)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">${uptime}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${p.pm2_env.restart_time || 0}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateLogs(logs) {
            const container = document.getElementById('logsContainer');
            const allLogs = [
                ...(logs || []).map(l => `[${l.timestamp || ''}] ${l.data || ''}`),
            ].filter(Boolean);

            if (allLogs.length === 0) {
                container.innerHTML = '<p class="text-slate-400">No logs available</p>';
                return;
            }

            container.innerHTML = allLogs.map(log => {
                const color = log.toLowerCase().includes('error') ? 'text-red-400' :
                             log.toLowerCase().includes('warning') ? 'text-yellow-400' :
                             log.toLowerCase().includes('info') ? 'text-blue-400' : 'text-slate-300';
                return `<p class="${color} mb-1">${log}</p>`;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 MB';
            const mb = bytes / (1024 * 1024);
            return mb >= 1024 ? (mb / 1024).toFixed(1) + ' GB' : mb.toFixed(1) + ' MB';
        }

        function formatUptime(seconds) {
            if (!seconds) return '-';
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return days > 0 ? `${days}d ${hours}h` : `${hours}h ${minutes}m`;
        }

        function clearLogs() {
            document.getElementById('logsContainer').innerHTML = '<p class="text-slate-400">Logs cleared</p>';
        }

        // Initial load
        refreshData();
    </script>
</body>
</html>
